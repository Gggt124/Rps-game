# README - RPS (Rock-Paper-Scissors-Lizard-Spock) Smart Contract

สมาร์ทคอนแทรคนี้เป็นการนำเกม Rock-Paper-Scissors-Lizard-Spock มาทำในรูปแบบกระจายศูนย์ (Decentralized) ด้วย Solidity โดยผู้เล่น 2 คนสามารถเข้าร่วมเกม เลือกตัวเลือกของตัวเองในรูปแบบที่ปกปิดไว้จนกว่าจะถึงเวลาที่จะเผยตัวเลือก และระบบจะตรวจสอบผลการเล่นตามกฎของเกม

## คุณสมบัติหลัก:
- **Commit-Reveal Scheme**: ทำให้การเลือกของผู้เล่นถูกปกปิดไว้จนกว่าทั้งสองจะเปิดเผยตัวเลือก
- **การจัดการเวลา**: ตรวจสอบการล่าช้าและอนุญาตให้ขอคืนเงินหากผู้เล่นไม่ทำการ Commit หรือ Reveal ภายในระยะเวลาที่กำหนด
- **Whitelisted**: เฉพาะที่อยู่ที่ได้รับอนุญาตเท่านั้นที่สามารถเข้าร่วมเกมได้
- **Refunds**: หากผู้เล่นไม่ทำการ Commit หรือ Reveal ในเวลาที่กำหนด ระบบจะคืนเงินให้กับผู้เล่น

## การทำงานของสมาร์ทคอนแทรค:

### 1. การป้องกันการล็อคเงินไว้ในคอนแทรค:
- **Refund Mechanism**: หากเกมไม่ดำเนินการตามปกติ (เช่นมีเพียงผู้เล่นคนเดียวที่ Commit หรือ Reveal) ผู้เล่นสามารถขอคืนเงินได้ โดย:
  - หากมีเพียงผู้เล่นคนเดียว ระบบจะคืนเงิน 1 ether ให้กับผู้เล่นคนนั้น
  - หากผู้เล่นทั้งสองคนเข้าร่วมเกมแต่ไม่เปิดเผยตัวเลือกภายใน 2 นาที ระบบจะคืนเงินให้กับผู้เล่นที่ยังไม่ได้ Reveal
- ฟังก์ชัน `refund()` จะตรวจสอบสถานะของเกม (จำนวนผู้เล่นและการเปิดเผยตัวเลือก) และให้ผู้เล่นขอคืนเงินหากมีการล่าช้าหรือปัญหา

### 2. การซ่อนตัวเลือกด้วย Commit-Reveal Scheme:
- **Commit Phase**:
  - ผู้เล่นแต่ละคนจะต้อง Commit ตัวเลือกของตนเองในรูปแบบของค่า Hash (ผ่านฟังก์ชัน `commitinput`) ซึ่งจะซ่อนตัวเลือกจากผู้เล่นอีกฝ่าย
  - ค่า Hash จะถูกสร้างขึ้นจากตัวเลือกของผู้เล่นและข้อมูลลับ เพื่อให้ไม่สามารถรู้ตัวเลือกของผู้เล่นจนกว่าจะเปิดเผย
  - ฟังก์ชัน `commitRevealp0.commit()` และ `commitRevealp1.commit()` จะเก็บ Hash ของแต่ละผู้เล่น ขึ้นอยู่กับว่าใครเป็นผู้ Commit
  - ตัวแปร `player_not_commit` ใช้ตรวจสอบว่าผู้เล่นแต่ละคนยังไม่ได้ Commit หรือไม่
- **Reveal Phase**:
  - หลังจากผู้เล่นทั้งสองคน Commit แล้ว พวกเขาจะต้องเปิดเผยตัวเลือกที่แท้จริงโดยใช้ฟังก์ชัน `reveal()`
  - เมื่อเปิดเผย ผู้เล่นจะส่งค่า Hash ที่ใช้ในขั้นตอนการ Commit
  - หาก Hash ที่เปิดเผยตรงกับ Hash ที่ Commit ผู้เล่นจะถูกยอมรับตัวเลือก
  - ขั้นตอนนี้ช่วยให้ผู้เล่นไม่สามารถเปลี่ยนแปลงตัวเลือกหลังจากที่ Commit ไปแล้ว

### 3. การจัดการกับความล่าช้าหากผู้เล่นไม่ครบทั้งสองคน:
- **รอผู้เล่น**: 
  - คอนแทรคอนุญาตให้มีผู้เล่นได้ 2 คน หากผู้เล่นคนที่สองไม่เข้าร่วม เกมจะต้องรอ
  - เกมจะเริ่มเมื่อผู้เล่นทั้งสองเข้าร่วม หากผู้เล่นคนที่สองไม่เข้าร่วมภายในระยะเวลาที่เหมาะสม ผู้เล่นคนแรกสามารถขอคืนเงินได้ภายใน 2 นาทีโดยใช้ฟังก์ชัน `refund()`
  - ฟังก์ชัน `timeUnit.elapsedMinutes()` ใช้ในการตรวจสอบเวลาตั้งแต่เริ่มเกมเพื่อให้รู้ว่าเมื่อไหร่สามารถขอคืนเงินได้

### 4. การเปิดเผยตัวเลือกและการตัดสินผู้ชนะ:
- **Reveal Phase**:
  - หลังจากที่ผู้เล่นทั้งสองคนเปิดเผยตัวเลือกแล้ว คอนแทรคจะตรวจสอบว่าเลือกที่เปิดเผยนั้นถูกต้อง (โดยการตรวจสอบ Hash)
  - ฟังก์ชัน `getChoice()` จะดึงตัวเลือกจากค่า Hash ของผู้เล่น
- **การตัดสินผู้ชนะ**:
  - เกมนี้ทำตามกฎของ **Rock-Paper-Scissors-Lizard-Spock** โดยการเลือกแต่ละตัวเลือกมีการชนะและแพ้ตามกฎ:
    - Rock ชนะ Scissors และ Lizard
    - Paper ชนะ Rock และ Spock
    - Scissors ชนะ Paper และ Lizard
    - Lizard ชนะ Spock และ Paper
    - Spock ชนะ Scissors และ Rock
  - หากผู้เล่นชนะ เงินรางวัลทั้งหมดจะถูกโอนให้กับผู้ชนะ หากทั้งสองผู้เล่นเลือกเหมือนกัน เงินรางวัลจะถูกแบ่งให้เท่ากัน

### 5. การรีเซ็ตเกม:
- หลังจากตัดสินผู้ชนะหรือคืนเงินแล้ว คอนแทรคจะรีเซ็ต:
  - ข้อมูลผู้เล่นและสถานะของเกมทั้งหมดจะถูกลบ
  - เกมถัดไปสามารถเริ่มต้นได้โดยอนุญาตให้ผู้เล่นใหม่เข้าร่วม

## ฟังก์ชันหลัก:
- **addPlayer()**: อนุญาตให้ผู้เล่นเข้าร่วมเกมโดยจ่ายค่าเข้า 1 ether
- **refund()**: อนุญาตให้ผู้เล่นขอคืนเงินหากเกมไม่ดำเนินการตามที่คาดหวัง
- **commitinput()**: ผู้เล่น Commit ตัวเลือกโดยการส่งค่า Hash ของตัวเลือก
- **reveal()**: ผู้เล่นเปิดเผยตัวเลือกที่แท้จริง
- **_checkWinnerAndPay()**: ตัดสินผู้ชนะตามกฎของเกมและแจกจ่ายรางวัล
- **resetGame()**: รีเซ็ตเกมเพื่อเริ่มต้นเกมใหม่

## หมายเหตุ:
- **Whitelisted Players**: เฉพาะที่อยู่ในอาร์เรย์ `allowedAccounts` เท่านั้นที่สามารถเข้าร่วมเกมได้
- **Entry Fee**: ผู้เล่นต้องจ่าย 1 ether เพื่อเข้าร่วม ซึ่งจะถูกเพิ่มเข้าไปในรางวัลของเกม
- **Timeouts**: คอนแทรคใช้คอนแทรค `TimeUnit` เพื่อติดตามเวลาและมั่นใจว่าเกมดำเนินไปอย่างราบรื่น หากผู้เล่นไม่เปิดเผยตัวเลือกภายในเวลาที่กำหนด ระบบจะคืนเงิน
